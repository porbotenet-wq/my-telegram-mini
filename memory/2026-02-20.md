# 2026-02-20 — Daily Log

## Контекст
- Дата по серверу: 2026-02-20 (UTC), сессия началась ранее

## Работа (эта сессия)
1. ТЗ Фаза 1 (стабилизация) — 8 блоков, отправлено Алексею в Telegram (msg 454-458 area)
2. Алексей подтвердил старт Фазы 1 в Lovable ("Запустил")
3. Полный аудит бота: все 1640 строк index.ts + 4 _shared модуля
4. Создан BOT-AUDIT.md — полная карта: 10 ролей, ~50 экранов, 5 FSM, 30 типов документов, 13 найденных проблем
5. ТЗ Фаза 2 (рефакторинг) — TZ-PHASE2-REFACTOR.md, отправлено Алексею в 5 сообщениях

## Ключевые файлы в workspace
- BOT-AUDIT.md — аудит бота
- TZ-PHASE1-LOVABLE.md — ТЗ стабилизации
- TZ-PHASE2-REFACTOR.md — ТЗ рефакторинга
- memory/project-state.md, architecture.md, bugs-tracker.md, decisions-log.md, pensieve-index.md — Pensieve

## Статус проекта
- Фаза 1 (стабилизация): Алексей работает в Lovable, ждём результат
- Фаза 2 (рефакторинг): ТЗ готово, начнётся после Фазы 1
- Фаза 3 (визуал Architectural Cinema): Opus, после Фазы 2
- BUG-012 (anon key rotation): заблокирован, требует ручного действия Алексея в Supabase Dashboard

## Фаза 3 — Визуал (начало обсуждения)
- Алексей спросил про визуал, решили обсудить Фазу 3
- Провёл аудит текущего UI: прочитал Index.tsx, Dashboard.tsx, TopBar.tsx, TabBar.tsx, index.css, tailwind.config.ts, PROMPT-MONOLITH-v3.md
- Базовый фундамент MONOLITH уже есть: тёмная тема, CSS vars (bg0-bg3, t1-t3), Manrope + JetBrains Mono, KPI cards с border-left
- Что не дотягивает: TabBar (текст вместо иконок, sticky top вместо fixed bottom), нет LED-полосок 2px, нет glow, нет Risk Cards, нет Quick Actions 2×2, нет Bento Grid, нет micro-motion, нет entrance animations
- Предложил два варианта: ТЗ для Lovable или самостоятельная работа в ветке opus/monolith-components
- Ждём ответ Алексея какой подход выбрать

## Фаза 3 — Визуал MONOLITH (выполнено Lovable)
- Подготовлено ТЗ TZ-PHASE3-VISUAL.md (7 блоков), отправлено Алексею
- Lovable выполнил все 7 блоков: TabBar→bottom, ролевые дашборды→MONOLITH tokens, RiskCards, QuickActions, DirectorDashboard, stagger animations, MoreDrawer
- Коммит: 457043f "Integrate MONOLITH v3 UI"

## Фаза 4 — Новые модули (по мотивам Битрикс24)
- Алексей показал скриншоты Битрикс24, хочет консолидировать всё в STSphera
- Ключевые идеи: профиль сотрудника, карточки проектов с hero-image, чаты задач через TG, контекстное меню по роли+объекту
- Подготовлено ТЗ TZ-PHASE4-MODULES.md (4 модуля), отправлено Алексею
- Порядок: Карточки проектов → Профиль → Меню → Чаты
- Модуль 2 (карточки проектов) — полное ТЗ отправлено, Алексей запустил в Lovable

## Фаза 5 — AI-платформа документации (обсуждение)
- Алексей хочет: AI-инженер с ГОСТами/СНиПами/СП, работа с Word/Excel, генерация писем
- AI-инженер: RAG + нормативная база + глубокое рассуждение + узловые решения + статика
- Документы: генерация Word по шаблонам, Excel с AI в ячейках, деловые письма
- Предложены этапы A-E
- Алексей: нормативную базу парсить из открытых источников (docs.cntd.ru, protect.gost.ru, minstroyrf.gov.ru)
- Решение: идём поэтапно — сначала Модули 2-4, потом Этапы A-E
- $200 кредит на DigitalOcean — использовать для инфраструктуры AI-платформы

## Модуль 7: AI-Диспетчер (Daily Watchdog) — идея
- Агент каждый день (08:00) парсит все объекты и задачи
- Анализ: прогресс vs план, просрочки, дефицит, незакрытые алерты
- Рассылка в TG по ролям: директору сводка, РП детали, прорабам задачи, снабжению дефицит
- Эскалация: 1 день → исполнителю, 3 дня → РП, 7 дней → директору
- Два варианта: A (чистая логика, Edge Function + cron) или B (+ LLM для умного анализа)
- Статус: запомнить, реализация позже

## Модули 1 + 4 — выполнены Lovable (13:00 UTC)
- Модуль 1 (ProfilePage 353 строки + TeamPage 221 строка): аватар, контакты, KPI, редактирование, загрузка аватара в Storage, группировка команды по ролям, online dot, TG deep links
- Модуль 4 (ProjectMenu 315 строк): hero-шапка 120px, аватары команды, инструменты по 6 ролям, LED-полоска + badge, секция "Общее"
- Миграция: RLS на profiles (read all), Storage bucket "avatars" + политики
- Коммиты: d3ff720 (профиль+команда), 3b5e126 (ProjectMenu заменил MoreDrawer)
- Замечание: проверить наличие колонок phone/email/position/avatar_url/last_active_at в profiles

## ТЗ отправлены Lovable (13:30 UTC)
- Модуль 3 (ChatsPage): обсуждения через TG, таблица project_chats, фильтры по типу, deep links в TG-группы, FAB создания
- Этап A (AIChatPage): AI-чат с контекстом проекта, таблицы ai_conversations + ai_messages, системный промпт с данными объекта, быстрые вопросы, история диалогов
- Алексей запускает оба параллельно

## Инфраструктура
- Алексей развернул второй DO дроплет: 157.230.21.30
- Создал второго TG-бота (токен: 8459...PiM)
- Настройку второго инстанса делает кто-то другой (SSH с этого сервера не прошёл — нет ключа)
- Первый сервер (Opus): 209.97.156.214
- API прокси: yunyi.cfd/claude, модель: claude-opus-4-6
- Роли: Opus = координатор/ТЗ/аудит, второй агент = исполнитель/backend/код

## Lovable: Модуль 3 + Этап A — выполнены (14:00 UTC)
- Lovable сделал оба за один запрос: ChatsPage + AIChatPage + routing
- Модуль 3: фильтры по типу, список чатов с иконками, deep links на TG, FAB через Sheet
- Этап A: список диалогов, streaming через ai-chat Edge Function, ai_conversations + ai_messages, быстрые вопросы
- Оба доступны через Меню → Общее
- Ждём Publish для проверки кода в репо

## ТЗ Этап B — парсер нормативной базы (14:15 UTC)
- Подготовлено и отправлено Алексею (msg 597-598)
- Структура: normbase-parser/ — crawlers (cntd, gost, minstroy) + parser (pdf, html, tables) + chunker + embeddings + db (pgvector)
- Миграция: norm_documents + norm_chunks с vector(1536), ivfflat index, RLS
- Приоритет: 20 документов НВФ/СПК/алюминий (СП 28.13330, ГОСТ 22233, СТО НОСТРОЙ и др.)
- Stack: Node/TS, axios+cheerio, pdf-parse, openai SDK, supabase-js
- Деплой: на втором DO дроплете
- Назначение: для второго агента когда будет готов
