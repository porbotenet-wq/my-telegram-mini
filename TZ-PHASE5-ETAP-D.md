# –¢–ó –≠—Ç–∞–ø D ‚Äî –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (Word/Excel/–ü–∏—Å—å–º–∞)

> –ö–æ–Ω—Ç–µ–∫—Å—Ç: STSphera ‚Äî ERP –¥–ª—è —Å—Ç—Ä–æ–π–∫–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ: –∞–∫—Ç—ã, –ø–∏—Å—å–º–∞ –∑–∞–∫–∞–∑—á–∏–∫—É, —Ä–µ–µ—Å—Ç—Ä—ã, —Å–≤–æ–¥–∫–∏. –°–µ–π—á–∞—Å –≤—Å—ë –≤—Ä—É—á–Ω—É—é –≤ Word/Excel. –≠—Ç–∞–ø D –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ —à–∞–±–ª–æ–Ω—ã + AI.

---

## –¶–µ–ª—å

–î–æ–±–∞–≤–∏—Ç—å –≤ Mini App –º–æ–¥—É–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
1. Word (DOCX) ‚Äî –∞–∫—Ç—ã, –ø–∏—Å—å–º–∞, –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –ø–æ —à–∞–±–ª–æ–Ω–∞–º —Å –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞
2. Excel (XLSX) ‚Äî —Ä–µ–µ—Å—Ç—Ä—ã, —Å–≤–æ–¥–∫–∏, –ø–ª–∞–Ω-—Ñ–∞–∫—Ç –≤—ã–≥—Ä—É–∑–∫–∏
3. –î–µ–ª–æ–≤—ã–µ –ø–∏—Å—å–º–∞ ‚Äî AI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É (–∑–∞–∫–∞–∑—á–∏–∫, —Ç–µ–º–∞, —Ç–æ–Ω)
4. –í—Å—ë –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ –ø—Ä–æ–µ–∫—Ç—É, –¥–æ—Å—Ç—É–ø–Ω–æ –∏–∑ –º–µ–Ω—é –æ–±—ä–µ–∫—Ç–∞

---

## 1. –ù–æ–≤–∞—è Edge Function: `generate-document`

### Endpoint
`POST /generate-document`

### Request
```json
{
  "projectId": "uuid",
  "templateType": "act_hidden_works",
  "format": "docx",
  "params": {
    "date": "2026-03-15",
    "works": ["–ú–æ–Ω—Ç–∞–∂ –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –ù–í–§", "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Ç–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü–∏–∏"],
    "executor": "–û–û–û –°–§–ï–†–ê",
    "inspector": "–ò–≤–∞–Ω–æ–≤ –ò.–ò."
  }
}
```

### –®–∞–±–ª–æ–Ω—ã (templateType)

**Word (DOCX):**
- `act_hidden_works` ‚Äî –ê–∫—Ç —Å–∫—Ä—ã—Ç—ã—Ö —Ä–∞–±–æ—Ç (–ì–û–°–¢ –† 56926)
- `act_acceptance` ‚Äî –ê–∫—Ç –ø—Ä–∏—ë–º–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç
- `protocol_meeting` ‚Äî –ü—Ä–æ—Ç–æ–∫–æ–ª —Å–æ–≤–µ—â–∞–Ω–∏—è
- `letter_client` ‚Äî –ü–∏—Å—å–º–æ –∑–∞–∫–∞–∑—á–∏–∫—É (AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞)
- `letter_subcontractor` ‚Äî –ü–∏—Å—å–º–æ —Å—É–±–ø–æ–¥—Ä—è–¥—á–∏–∫—É
- `daily_report` ‚Äî –î–Ω–µ–≤–Ω–æ–π –æ—Ç—á—ë—Ç (—Ñ–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π)
- `defect_act` ‚Äî –ê–∫—Ç –æ –¥–µ—Ñ–µ–∫—Ç–∞—Ö/–∑–∞–º–µ—á–∞–Ω–∏—è—Ö

**Excel (XLSX):**
- `registry_materials` ‚Äî –†–µ–µ—Å—Ç—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ –æ–±—ä–µ–∫—Ç—É
- `plan_fact_export` ‚Äî –í—ã–≥—Ä—É–∑–∫–∞ –ø–ª–∞–Ω-—Ñ–∞–∫—Ç
- `crew_schedule` ‚Äî –ì—Ä–∞—Ñ–∏–∫ –±—Ä–∏–≥–∞–¥
- `supply_summary` ‚Äî –°–≤–æ–¥–∫–∞ –ø–æ —Å–Ω–∞–±–∂–µ–Ω–∏—é

### –õ–æ–≥–∏–∫–∞
1. –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram initData
2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑ –ë–î (projects, profiles, plan_fact, materials, crews)
3. –î–ª—è Word: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `docx` (npm) ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
4. –î–ª—è Excel: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `exceljs` (npm)
5. –î–ª—è –ø–∏—Å–µ–º (letter_*): –≤—ã–∑–≤–∞—Ç—å LLM —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–∞ + –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –≤ Supabase Storage bucket `generated-documents`
7. –í–µ—Ä–Ω—É—Ç—å signed URL (expires 1h)

### Response
```json
{
  "fileUrl": "https://jdnqaxldwyembanatnqd.supabase.co/storage/v1/...",
  "fileName": "–ê–∫—Ç_—Å–∫—Ä—ã—Ç—ã—Ö_—Ä–∞–±–æ—Ç_2026-03-15.docx",
  "expiresAt": "2026-03-15T14:00:00Z"
}
```

### AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å–µ–º
–î–ª—è templateType `letter_client` / `letter_subcontractor`:
```
System prompt:
–¢—ã ‚Äî –¥–µ–ª–æ–≤–æ–π –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –û–û–û ¬´–°–§–ï–†–ê¬ª.
–ü—Ä–æ–µ–∫—Ç: {project.name}, –∑–∞–∫–∞–∑—á–∏–∫: {project.client_name}.
–ì–µ–Ω–µ—Ä–∏—Ä—É–π –¥–µ–ª–æ–≤–æ–µ –ø–∏—Å—å–º–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
–¢–æ–Ω: –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π, –Ω–æ –Ω–µ –∫–∞–Ω—Ü–µ–ª—è—Ä—Å–∫–∏–π.
–§–æ—Ä–º–∞—Ç: —à–∞–ø–∫–∞ (–æ—Ç/–∫–æ–º—É/–¥–∞—Ç–∞/–∏—Å—Ö.‚Ññ) + —Ç–µ–ª–æ + –ø–æ–¥–ø–∏—Å—å.

User: {params.subject} ‚Äî {params.details}
```

---

## 2. –§—Ä–æ–Ω—Ç–µ–Ω–¥: DocumentGeneratorPage

### –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
–ú–µ–Ω—é –æ–±—ä–µ–∫—Ç–∞ (ProjectMenu) ‚Üí —Å–µ–∫—Ü–∏—è "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã" ‚Üí "üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã" (—É–∂–µ –µ—Å—Ç—å) ‚Üí –Ω–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞ "–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä"

### –≠–∫—Ä–∞–Ω: —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤
–î–≤–µ —Å–µ–∫—Ü–∏–∏:

**üìù –î–æ–∫—É–º–µ–Ω—Ç—ã (Word)**
–ö–∞—Ä—Ç–æ—á–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤ –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞:
- –ò–∫–æ–Ω–∫–∞ —Ç–∏–ø–∞ (FileText –¥–ª—è Word)
- –ù–∞–∑–≤–∞–Ω–∏–µ: "–ê–∫—Ç —Å–∫—Ä—ã—Ç—ã—Ö —Ä–∞–±–æ—Ç"
- –û–ø–∏—Å–∞–Ω–∏–µ: "–ì–û–°–¢ –† 56926, —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞"
- –¢–∞–ø ‚Üí —ç–∫—Ä–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**üìä –¢–∞–±–ª–∏—Ü—ã (Excel)**
- –ò–∫–æ–Ω–∫–∞ (Table –¥–ª—è Excel)
- –ù–∞–∑–≤–∞–Ω–∏–µ: "–†–µ–µ—Å—Ç—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤"
- –û–ø–∏—Å–∞–Ω–∏–µ: "–í—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ –æ–±—ä–µ–∫—Ç—É —Å –æ—Å—Ç–∞—Ç–∫–∞–º–∏"
- –¢–∞–ø ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ä–∞–∑—É (–¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î) –∏–ª–∏ —ç–∫—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä–æ–≤

### –≠–∫—Ä–∞–Ω: –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞
–§–æ—Ä–º–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç templateType:

`act_hidden_works`:
- –î–∞—Ç–∞ (DatePicker, default = —Å–µ–≥–æ–¥–Ω—è)
- –í–∏–¥—ã —Ä–∞–±–æ—Ç (MultiSelect –∏–∑ work_types –ø—Ä–æ–µ–∫—Ç–∞)
- –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (Input, default = "–û–û–û –°–§–ï–†–ê")
- –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Ç–µ—Ö–Ω–∞–¥–∑–æ—Ä–∞ (Select –∏–∑ –∫–æ–º–∞–Ω–¥—ã —Å —Ä–æ–ª—å—é inspector)
- –ö–Ω–æ–ø–∫–∞ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"

`letter_client`:
- –ö–æ–º—É (Input, default = project.client_name)
- –¢–µ–º–∞ –ø–∏—Å—å–º–∞ (Input)
- –î–µ—Ç–∞–ª–∏ / —á—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å (Textarea, 3 —Å—Ç—Ä–æ–∫–∏)
- –¢–æ–Ω: –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π / –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π / –°—Ä–æ—á–Ω—ã–π (SegmentedControl)
- –ö–Ω–æ–ø–∫–∞ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–æ"
- Preview: –ø–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞ –ø–µ—Ä–µ–¥ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º
- –ö–Ω–æ–ø–∫–∏: "üì• –°–∫–∞—á–∞—Ç—å DOCX" / "‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" / "üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"

### –≠–∫—Ä–∞–Ω: —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- Preview –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–¥–ª—è –ø–∏—Å–µ–º ‚Äî —Ç–µ–∫—Å—Ç, –¥–ª—è —Ç–∞–±–ª–∏—Ü ‚Äî –ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫)
- –ö–Ω–æ–ø–∫–∞ "üì• –°–∫–∞—á–∞—Ç—å" ‚Üí –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç signed URL
- –ö–Ω–æ–ø–∫–∞ "üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ TG" ‚Üí —à–∞—Ä–∏—Ç —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ —á–∞—Ç –ø—Ä–æ–µ–∫—Ç–∞
- –ò—Å—Ç–æ—Ä–∏—è: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

### –í–∏–∑—É–∞–ª MONOLITH
- –ö–∞—Ä—Ç–æ—á–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤: `bg-bg1`, `rounded-2xl`, `p-4`, `border border-border/10`
- –ò–∫–æ–Ω–∫–∞: `w-10 h-10`, `bg-bg2`, `rounded-xl`, —Ü–≤–µ—Ç –ø–æ —Ç–∏–ø—É (blue=Word, green=Excel)
- –ù–∞–∑–≤–∞–Ω–∏–µ: `text-[15px]`, `font-semibold`, `text-t1`
- –û–ø–∏—Å–∞–Ω–∏–µ: `text-[12px]`, `text-t3`
- –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: `bg-primary`, `text-white`, `rounded-xl`, `h-12`
- Loading: skeleton + "‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –¥–æ–∫—É–º–µ–Ω—Ç..."
- –¢–∞–ø-–∑–æ–Ω—ã: 56px+

---

## 3. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

```sql
-- –ò—Å—Ç–æ—Ä–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
CREATE TABLE IF NOT EXISTS generated_documents (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id uuid REFERENCES projects(id) NOT NULL,
  user_id uuid REFERENCES auth.users(id) NOT NULL,
  template_type text NOT NULL,
  format text NOT NULL DEFAULT 'docx', -- docx, xlsx
  params jsonb DEFAULT '{}'::jsonb,
  file_path text, -- –ø—É—Ç—å –≤ Storage
  file_name text NOT NULL,
  ai_generated boolean DEFAULT false,
  created_at timestamptz DEFAULT now()
);

-- RLS
ALTER TABLE generated_documents ENABLE ROW LEVEL SECURITY;

-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–≤–æ–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
CREATE POLICY "Project members can view generated docs"
  ON generated_documents FOR SELECT
  USING (
    project_id IN (
      SELECT project_id FROM profiles WHERE user_id = auth.uid()
    )
  );

-- –°–æ–∑–¥–∞–≤–∞—Ç—å –º–æ–∂–µ—Ç –ª—é–±–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–æ–µ–∫—Ç–∞
CREATE POLICY "Project members can create generated docs"
  ON generated_documents FOR INSERT
  WITH CHECK (
    project_id IN (
      SELECT project_id FROM profiles WHERE user_id = auth.uid()
    )
  );

-- Storage bucket
-- –°–æ–∑–¥–∞—Ç—å bucket: generated-documents (private)
-- –ü–æ–ª–∏—Ç–∏–∫–∞: authenticated users, path starts with their project_id

CREATE INDEX IF NOT EXISTS idx_generated_docs_project
  ON generated_documents(project_id, created_at DESC);
```

---

## 4. Storage

Bucket: `generated-documents` (private)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:
```
generated-documents/
  {project_id}/
    {template_type}_{date}_{uuid_short}.docx
    {template_type}_{date}_{uuid_short}.xlsx
```

–ü–æ–ª–∏—Ç–∏–∫–∏:
- SELECT: —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ (—á–µ—Ä–µ–∑ profiles.project_id)
- INSERT: —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞

---

## 5. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- npm –ø–∞–∫–µ—Ç—ã –≤ Edge Function: `docx` (Word), `exceljs` (Excel)
- –ò–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è Deno: `docx` —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Deno, `exceljs` ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –ï—Å–ª–∏ exceljs –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Deno ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `xlsx` (SheetJS) –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å CSV
- OpenAI/Claude API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –ø–∏—Å–µ–º (—É–∂–µ –µ—Å—Ç—å –≤ ai-chat)
- Supabase Storage –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

## 6. –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç

1. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î + Storage bucket
2. Edge Function `generate-document` (–Ω–∞—á–∞—Ç—å —Å 2-3 —à–∞–±–ª–æ–Ω–æ–≤: act_hidden_works, letter_client, plan_fact_export)
3. –§—Ä–æ–Ω—Ç–µ–Ω–¥: DocumentGeneratorPage + —Å–ø–∏—Å–æ–∫ —à–∞–±–ª–æ–Ω–æ–≤ + —Ñ–æ—Ä–º—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
4. AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å–µ–º (letter_client)
5. –û—Å—Ç–∞–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–æ–±–∞–≤–ª—è—Ç—å –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ
